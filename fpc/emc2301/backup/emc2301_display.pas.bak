unit emc2301_display;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils, Forms, Controls, Graphics, Dialogs, StdCtrls, Buttons,
  Menus, emc2301_pyth_util, PythonEngine;

type

  { TForm_emc2301 }

  TForm_emc2301 = class(TForm)
    BitBtn_setting: TBitBtn;
    ComboBox_mode: TComboBox;
    ComboBox_temp: TComboBox;
    ComboBox_hmdt: TComboBox;
    ComboBox_heating: TComboBox;
    Edit_manuf: TEdit;
    Edit_devid: TEdit;
    Edit_temp: TEdit;
    Edit_hmdt: TEdit;
    Edit_serial: TEdit;
    GroupBox_accuracy: TGroupBox;
    GroupBox_settings: TGroupBox;
    GroupBox_measure_box: TGroupBox;
    ImageList_emc2301: TImageList;
    Label_mid: TLabel;
    Label_heating: TLabel;
    Label_mode: TLabel;
    Label_temp: TLabel;
    Label_hmdt: TLabel;
    Label_mtemp: TLabel;
    Label_mhmdt: TLabel;
    MainMenu: TMainMenu;
    Help: TMenuItem;
    Creator: TMenuItem;
    PythonEngine_emc2301: TPythonEngine;
    PythonInputOutput_emc2301: TPythonInputOutput;
    procedure BitBtn_settingClick(Sender: TObject);
    procedure ComboBox_heatingChange(Sender: TObject);
    procedure ComboBox_hmdtChange(Sender: TObject);
    procedure ComboBox_modeChange(Sender: TObject);
    procedure ComboBox_tempChange(Sender: TObject);
    procedure CreatorClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure HelpClick(Sender: TObject);
    procedure PythonInputOutput_emc2301_SendData(Sender: TObject;
      const Data: AnsiString);
  private
    procedure DoPy_InitEngine;
  public
  end;

var
  Form_emc2301: TForm_emc2301;
  emc: emc2301Ob;
  emc_attr: PyRecordOb;
  emc_c:  emc2301Ob_c;
  emc_c_attr: PyRecordOb_c;
  Ob_emc_c_attr: array[1..50] of PyRecordOb_c;
  ObI_emc_attr: array[1..2] of PyRecordIOb;
  Ob_emc_attr: array[1..50] of PyRecordOb;
  Ob_emc_c: array[1..50] of emc2301Ob_c;
  idx_emc_attr,idx_emc_c_attr,idx_emc_c: integer;
  test: integer;


implementation

{$R *.lfm}

uses emc2301_read, emc2301_write, creator, help, missing_chip;

const
  cPyLibraryLinux = 'libpython3.7m.so.1.0';
  PASSED = 0;
  FAILED = 1;

procedure TForm_emc2301.DoPy_InitEngine;
var
  S: string;
begin
  S:=
    {$ifdef linux} cPyLibraryLinux {$endif};
  PythonEngine_emc2301.DllPath:= ExtractFileDir(S);
  PythonEngine_emc2301.DllName:= ExtractFileName(S);
  PythonEngine_emc2301.LoadDll;
end;

procedure TForm_emc2301.FormCreate(Sender: TObject);
var
  i: Integer;
begin

  DoPy_InitEngine;

  emc := emc2301Ob.Init;
    for i in [1..50] do
    begin
    if i=1 then
       ObI_emc_attr[1]:= PyRecordIOb.Init
     else
       Ob_emc_attr[i]:= PyRecordOb.Init;

    Ob_emc_c[i]:= emc2301Ob_c.Init;
    Ob_emc_c_attr[i]:=PyRecordOb_c.Init;
    end;

  idx_emc_attr :=1;
  idx_emc_c_attr :=1;
  idx_emc_c :=1;
  test := FAILED;

  self_test();
  if (test = 0) then
     begin
      Application.ShowMainForm := True;
      Form_emc2301.Visible:= True;
      Application.CreateForm(TForm_creator, Form_creator);
      Application.CreateForm(TForm_help, Form_help);
      read_emc();
      read_measure();
     end;

end;

procedure TForm_emc2301.HelpClick(Sender: TObject);
begin
  Form_help.Show;
end;

procedure TForm_emc2301.ComboBox_tempChange(Sender: TObject);
var bit: String;
begin
  bit := IntToEnum (1,Form_emc2301.ComboBox_temp.ItemIndex);   //temp accuracy button - new status
  emc.attr1.attr_val_obj.attr2.attr_new_val := bit;
  emc.attr1.attr_val_obj.attr2.attr_chg := true;
  Form_emc2301.BitBtn_setting.ImageIndex := 1;
end;

procedure TForm_emc2301.CreatorClick(Sender: TObject);
begin
  Form_creator.Show;
end;

procedure TForm_emc2301.ComboBox_hmdtChange(Sender: TObject);
var bit: String;
begin
  bit := IntToEnum (0,Form_emc2301.ComboBox_hmdt.ItemIndex);
  emc.attr1.attr_val_obj.attr1.attr_new_val := bit;           //hmdt accuracy button - new status
  emc.attr1.attr_val_obj.attr1.attr_chg := true;
  Form_emc2301.BitBtn_setting.ImageIndex := 1;
end;

procedure TForm_emc2301.ComboBox_modeChange(Sender: TObject);
var bit: String;
begin
  bit := IntToEnum_MODE (Form_emc2301.ComboBox_mode.ItemIndex);
  emc.attr1.attr_val_obj.attr4.attr_new_val := bit;          //mode button - new status
  emc.attr1.attr_val_obj.attr4.attr_chg := true;
  Form_emc2301.BitBtn_setting.ImageIndex := 1;
end;

procedure TForm_emc2301.ComboBox_heatingChange(Sender: TObject);
var bit: String;
begin
  bit := IntToEnum_HEAT (Form_emc2301.ComboBox_heating.ItemIndex);
  emc.attr1.attr_val_obj.attr5.attr_new_val := bit;         //heat button - new status
  emc.attr1.attr_val_obj.attr5.attr_chg := true;
  Form_emc2301.BitBtn_setting.ImageIndex := 1;
end;

procedure TForm_emc2301.BitBtn_settingClick(Sender: TObject);
begin
  write_conf_reg();
  read_emc();
  read_measure();
  Form_emc2301.BitBtn_setting.ImageIndex := 0;
end;


procedure TForm_emc2301.PythonInputOutput_emc2301_SendData(Sender: TObject;
  const Data: AnsiString);
begin

  emc := StrToObj(data);

  case emc.attr1.code_type of
   'READ_emc':
       read_output_emc(emc);
   'READ_emc_ERR':
     writeln('read_emc_err');
   'READ_MEASURE':
     read_measure_emc(emc);
   'READ_MEASURE_ERR':
     writeln('read_measure_err');
   'WRITE_REG_CONF':
     writeln('Success write to CONF Register');
   'TEST_PASSED':
     begin
       writeln('Selftest correct');
       test := PASSED;
     end;
   'MISSING_CHIP':
     begin
       writeln('Missed chip');
       test := FAILED;
       Form_emc2301.Deactivate;
       Application.CreateForm(TForm_missing_chip, Form_missing_chip);
       Form_missing_chip.Visible:= True;
     end
    else
     begin
       //writeln(emc.attr1.code_type);
       exit;
     end;
    end;

end;

end.

